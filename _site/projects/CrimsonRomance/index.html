<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Crimson Romance</title>
	<link rel="stylesheet" href="/css/screen.css" />
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
	<script src="/js/jquery-2.1.1.min.js"></script>
</head>
<body>
<nav class="topnav">
	<!--<div class="button-group">-->
	<label for="show-menu" class="show-menu">Menu</label>
	<input type="checkbox" id="show-menu" role="button">
	<ul id="menu">
		<li>
			<a href="/">Home</a>
		</li>
		<li>
			<a href="/projects">Projects</a>
		</li>
		<li>
			<a href="/experience">Experience</a>
		</li>
	</ul>
		
</nav>
<article class="project">
	<header>
		<h1>Crimson Romance </h1>
		<h2>Ebook series with script-based workflow, 2013-2016</h2>
	</header>
	<section>
		<p>Crimson Romance is the romance line at Adams Media. This is an ebook-first series. For this series, I helped with a transition to a CMS-based workflow. I was the sole developer on this series during my time at F+W Media, with 2 to 3 titles being published per week.</p>

<p><img src="../../img/crimsonromance/1-library.jpg" alt="Library of Crimson Romance ebooks" /></p>

<p>Due to the quick turnaround with this series, I was presented with an interesting challenge. The CMS filled in the metadata fields for the EPUB export; however, since the content was outpacing the metadata for this fast-paced workflow, I had to enter in that information manually: the cover, author name, title, and ISBN. Initially, I set up a set of regexes that I would run upon opening the files, but eventually I created a Python script. The script is available <a href="https://github.com/francofaa/RomanceEPUBCleanup">here on github</a>. </p>

<p>Itâ€™s also down here:</p>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><code class="language-python" data-lang="python"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92</code></pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">zipfile</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shutil</span>

<span class="n">firstName</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Author</span><span class="se">\&#39;</span><span class="s">s first name: &#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">firstName</span><span class="p">)</span>
<span class="n">lastName</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Author</span><span class="se">\&#39;</span><span class="s">s last name: &#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">lastName</span><span class="p">)</span>

<span class="n">bookFolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

<span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">bookFolder</span><span class="p">):</span>
	<span class="k">if</span> <span class="nb">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.epub&#39;</span><span class="p">):</span>
		<span class="n">foul</span> <span class="o">=</span> <span class="nb">file</span>

<span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">bookFolder</span><span class="p">):</span>
	<span class="k">if</span> <span class="nb">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.jpg&#39;</span><span class="p">):</span>
		<span class="n">isbn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="nb">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">isbn</span><span class="p">)</span>
<span class="n">zip_ref</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">foul</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
<span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">isbn</span><span class="p">)</span>
<span class="n">zip_ref</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">epub_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bookFolder</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">isbn</span><span class="p">)</span>
<span class="n">oebps_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">epub_folder</span> <span class="o">+</span> <span class="s">&#39;/OEBPS&#39;</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">isbn</span> <span class="o">+</span> <span class="s">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s">&#39;cover.jpg&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">bookFolder</span><span class="p">):</span>
	<span class="k">if</span> <span class="nb">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.jpg&#39;</span><span class="p">):</span>
		<span class="n">coverImg</span> <span class="o">=</span> <span class="nb">file</span>

<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coverImg</span><span class="p">,</span> <span class="n">oebps_folder</span> <span class="o">+</span> <span class="s">&#39;/images&#39;</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s">&#39;cover.jpg&#39;</span><span class="p">,</span> <span class="n">isbn</span> <span class="o">+</span> <span class="s">&#39;.jpg&#39;</span><span class="p">)</span>

<span class="n">opf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">oebps_folder</span> <span class="o">+</span> <span class="s">&#39;/content.opf&#39;</span><span class="p">)</span>
<span class="n">opf_contents</span> <span class="o">=</span> <span class="n">opf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">opf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">oebps_folder</span> <span class="o">+</span> <span class="s">&#39;/content.opf&#39;</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>

<span class="n">opf_contents</span> <span class="o">=</span> <span class="n">opf_contents</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="n">opf_contents</span> <span class="o">=</span> <span class="n">opf_contents</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="n">opf_contents</span> <span class="o">=</span> <span class="n">opf_contents</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;  &#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span>

<span class="n">spine_regex</span> <span class="o">=</span> <span class="s">&#39;&lt;spine toc=&quot;ncx&quot; page-progression-direction=&quot;ltr&quot;&gt;</span><span class="se">\n</span><span class="s">&lt;itemref idref=&quot;toc&quot; /&gt;</span><span class="se">\n</span><span class="s"> &lt;itemref idref=&quot;(.*?)&quot; /&gt;</span><span class="se">\n</span><span class="s"> &lt;itemref idref=&quot;(.*?)&quot; /&gt;&#39;</span>
<span class="n">spine_subst</span> <span class="o">=</span> <span class="s">r&#39;&lt;spine toc=&quot;ncx&quot; page-progression-direction=&quot;ltr&quot;&gt;&lt;itemref idref=&quot;cover&quot; linear=&quot;yes&quot; /&gt;&lt;itemref idref=&quot;\1&quot; /&gt;&lt;itemref idref=&quot;\2&quot; /&gt;&lt;itemref idref=&quot;newsletter&quot; /&gt;&lt;itemref idref=&quot;toc&quot; /&gt;&#39;</span>
<span class="n">opf_contents</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">spine_regex</span><span class="p">,</span> <span class="n">spine_subst</span><span class="p">,</span> <span class="n">opf_contents</span><span class="p">)</span>

<span class="n">metadata_regex</span> <span class="o">=</span> <span class="s">&#39;&lt;dc:identifier id=&quot;bookid&quot;&gt;&lt;/dc:identifier&gt;</span><span class="se">\n</span><span class="s">&lt;dc:date&gt;(.*?)&lt;/dc:date&gt;</span><span class="se">\n</span><span class="s">&lt;dc:rights&gt;&lt;/dc:rights&gt;&#39;</span>
<span class="n">metadata_subst</span> <span class="o">=</span> <span class="s">r&#39;&lt;dc:date&gt;\1&lt;/dc:date&gt;&lt;dc:identifier id=&quot;bookid&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">isbn</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&#39;&lt;/dc:identifier&gt;&lt;dc:creator id=&quot;mainauthor1&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">firstName</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lastName</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&#39;&lt;/dc:creator&gt;&lt;meta refines=&quot;#mainauthor1&quot; property=&quot;role&quot; scheme=&quot;marc:relators&quot;&gt;aut&lt;/meta&gt;&lt;meta refines=&quot;#mainauthor1&quot; property=&quot;file-as&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lastName</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">firstName</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&#39;&lt;/meta&gt;&lt;meta refines=&quot;#mainauthor1&quot; property=&quot;display-seq&quot;&gt;1&lt;/meta&gt;&lt;dc:publisher&gt;Adams Media&lt;/dc:publisher&gt;&lt;dc:rights&gt;WORLD&lt;/dc:rights&gt;&#39;</span>
<span class="n">opf_contents</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">metadata_regex</span><span class="p">,</span> <span class="n">metadata_subst</span><span class="p">,</span> <span class="n">opf_contents</span><span class="p">)</span>

<span class="n">opf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">opf_contents</span><span class="p">)</span>
<span class="n">opf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">nav</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">oebps_folder</span> <span class="o">+</span> <span class="s">&#39;/nav.xhtml&#39;</span><span class="p">)</span>
<span class="n">nav_contents</span> <span class="o">=</span> <span class="n">nav</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">nav</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">oebps_folder</span> <span class="o">+</span> <span class="s">&#39;/nav.xhtml&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

<span class="n">nav_regex</span> <span class="o">=</span> <span class="s">r&#39;&lt;ol class=&quot;epub_landmarks&quot; epub:type=&quot;list&quot;&gt;&#39;</span>
<span class="n">nav_subst</span> <span class="o">=</span> <span class="s">r&#39;&lt;ol class=&quot;epub_landmarks&quot; epub:type=&quot;list&quot;&gt;\n&lt;li&gt;&lt;a epub:type=&quot;cover&quot; href=&quot;cover.xhtml&quot;&gt;Cover&lt;/a&gt;&lt;/li&gt;&#39;</span>
<span class="n">nav_contents</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">nav_regex</span><span class="p">,</span> <span class="n">nav_subst</span><span class="p">,</span> <span class="n">nav_contents</span><span class="p">)</span>

<span class="n">nav</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nav_contents</span><span class="p">)</span>
<span class="n">nav</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">ncx</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">oebps_folder</span> <span class="o">+</span> <span class="s">&#39;/toc.ncx&#39;</span><span class="p">)</span>
<span class="n">ncx_contents</span> <span class="o">=</span> <span class="n">ncx</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">ncx</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">oebps_folder</span> <span class="o">+</span> <span class="s">&#39;/toc.ncx&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>

<span class="n">ncx_regex</span> <span class="o">=</span> <span class="s">r&#39;&lt;meta name=&quot;dtb:uid&quot; content=&quot;&quot; /&gt;&#39;</span>
<span class="n">ncx_subst</span> <span class="o">=</span> <span class="s">r&#39;&lt;meta name=&quot;dtb:uid&quot; content=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">isbn</span><span class="p">)</span> <span class="o">+</span> <span class="s">r&#39;&quot; /&gt;&#39;</span>
<span class="n">ncx_contents</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ncx_regex</span><span class="p">,</span> <span class="n">ncx_subst</span><span class="p">,</span> <span class="n">ncx_contents</span><span class="p">)</span>

<span class="n">ncx</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ncx_contents</span><span class="p">)</span>
<span class="n">ncx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">build_epub</span><span class="p">(</span><span class="n">epub_name</span><span class="p">,</span> <span class="nb">dir</span><span class="p">):</span>
	<span class="n">dir_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">epub_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
					<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
					<span class="n">entry</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">dir_length</span><span class="p">:]</span>
					<span class="n">zf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>

<span class="n">bookFolderName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">bookFolder</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">build_epub</span><span class="p">(</span><span class="n">isbn</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">bookFolderName</span> <span class="o">+</span> <span class="s">&#39;.epub&#39;</span><span class="p">,</span> <span class="n">epub_folder</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">foul</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">isbn</span><span class="p">)</span>
</pre></div>
</td></tr></table>


	</section>
</article>

<div class="PageNavigation">

  
    <a class="prev" href="/projects/Beowulf"><button class="left-btn">&laquo; Beowulf</button></a>
  

  
   <a class="next" href="/projects/Once"><button class="right-btn"> Once Magazine &raquo;</button></a>
  
</div>
<a href="/index.html#contact"><button class="contact-link">Contact me</button></a>
<footer>
	<p class="copyright">&copy; Franco A. Alvarado 2016. 
		<!--<a href="">Blog</a>-->
		
	 | <a href="https://twitter.com/">
		      <i class="fa fa-twitter"></i> 
		    </a>
		
		
		    | <a href="https://github.com/">
		      <i class="fa fa-github"></i> 
		    </a>
		
		 </p>
</footer>
<script src="/js/functions.js"></script>
</body>
</html>